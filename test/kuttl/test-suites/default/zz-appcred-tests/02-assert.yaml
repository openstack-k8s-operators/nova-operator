apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 600
commands:
  - script: |-
      set -euo pipefail
      NS="${NAMESPACE}"

      echo "Waiting for KeystoneApplicationCredential ac-nova to be Ready..."
      oc wait -n "${NS}" appcred/ac-nova --for=condition=Ready --timeout=300s

      ac_id=$(oc get -n "${NS}" appcred/ac-nova -o jsonpath='{.status.acID}')
      if [ -z "${ac_id}" ]; then
        echo "ERROR: appcred/ac-nova.status.acID is empty"
        exit 1
      fi
      echo "ac-nova.status.acID=${ac_id}"

      echo "Waiting for Secret ac-nova-secret..."
      for _ in $(seq 1 60); do
        if oc get -n "${NS}" secret/ac-nova-secret >/dev/null 2>&1; then
          break
        fi
        sleep 2
      done
      oc get -n "${NS}" secret/ac-nova-secret >/dev/null

      secret_ac_id=$(oc get -n "${NS}" secret/ac-nova-secret -o jsonpath='{.data.AC_ID}' | base64 -d)
      if [ "${secret_ac_id}" != "${ac_id}" ]; then
        echo "ERROR: Secret AC_ID (${secret_ac_id}) != appcred.status.acID (${ac_id})"
        exit 1
      fi
      echo "✓ Secret AC_ID matches appcred.status.acID"

      echo "Waiting for nova-kuttl-cell1-conductor rollout..."
      oc rollout status -n "${NS}" statefulset/nova-kuttl-cell1-conductor --timeout=300s

      old_uid=$(oc get -n "${NS}" configmap/appcred-nova-pre -o jsonpath='{.data.cell1_conductor_uid}')
      new_uid=$(oc get -n "${NS}" pod/nova-kuttl-cell1-conductor-0 -o jsonpath='{.metadata.uid}')
      if [ "${old_uid}" = "${new_uid}" ]; then
        echo "ERROR: nova-kuttl-cell1-conductor-0 UID did not change after appcred secret became available"
        echo "  uid=${new_uid}"
        exit 1
      fi
      echo "✓ nova-kuttl-cell1-conductor-0 UID changed (restart observed)"

      echo "Checking nova config contains application_credential_id..."
      oc exec -n "${NS}" pod/nova-kuttl-cell1-conductor-0 -c nova-kuttl-cell1-conductor-conductor -- \
        bash -c "grep -q \"^application_credential_id = ${ac_id}$\" /etc/nova/nova.conf.d/01-nova.conf"
      echo "✓ nova config contains expected application_credential_id"
